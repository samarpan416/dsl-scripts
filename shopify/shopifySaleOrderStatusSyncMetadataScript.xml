<scraper name="shopifySaleOrderStatusSyncMetadataScript" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.unicommerce.com/schema/scraper-1.0.xsd">
	
	<var name="getServiceBaseUrlResponse" value="#{new java.util.HashMap()}" />
	<invoke method="getServiceBaseUrl" script="shopifyUtils">
		<param name="getServiceBaseUrlResponse" value="#{#getServiceBaseUrlResponse}" />
	</invoke>
	<var name="SHOPIFY_MS_BASE_URL" value="#{#getServiceBaseUrlResponse.get('baseUrl')}" />

    <method name="prepareGetOrdersStatusSyncMetadataRequestHeaders">
		<var name="requiredHeaders" value="#{new java.util.HashMap()}" />
        <invoke method="getRequiredServiceRequestHeaders" script="shopifyUtils">
            <param name="requiredHeaders" value="#{#requiredHeaders}" />
            <param name="hostname" value="#{#hostname}" />
            <param name="locationId" value="#{#locationId}" />
            <param name="apiKey" value="#{#apiKey}" />
            <param name="password" value="#{#password}" />
            <param name="tenantCode" value="#{T(com.uniware.core.utils.UserContext).current().tenant.code}" />
            <param name="channelCode" value="#{#channel.code}" />
            <param name="channelSourceCode" value="#{#channel.sourceCode}" />
        </invoke>

		<var name="getOrdersStatusSyncMetadataRequestHeaders" value="#{new java.util.HashMap()}" />
		<var value="#{#getOrdersStatusSyncMetadataRequestHeaders.putAll(#requiredHeaders)}" />

		<log level="info" value="getOrdersStatusSyncMetadataRequestHeaders: #{#getOrdersStatusSyncMetadataRequestHeaders.toString()}" />
	</method>

    <method name="doGetOrdersStatusSyncMetadataRequest">
		<http method="GET" url="#{#SHOPIFY_MS_BASE_URL}/orders/status-sync/metadata" var="getOrdersStatusSyncMetadataResponse" fetchStatusCode="true">
			<headers map="#{#getOrdersStatusSyncMetadataRequestHeaders}" />
		</http>

		<log level="info" value="getOrdersStatusSyncMetadataResponse: #{#getOrdersStatusSyncMetadataResponse}" />
	</method>

    <method name="handleGetOrdersStatusSyncMetadataResponse">
		<if condition="#{#getOrdersStatusSyncMetadataResponseCode == 200}">
			<var name="getOrdersStatusSyncMetadataResponseJson" value="#{T(com.unifier.core.utils.JsonUtils).stringToJson(#getOrdersStatusSyncMetadataResponse)}" />
			<var name="responseStatus" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#getOrdersStatusSyncMetadataResponseJson, 'status')}" />
			<var name="responseMessage" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#getOrdersStatusSyncMetadataResponseJson, 'message')}" />
			<var name="responseErrors" value="#{#getOrdersStatusSyncMetadataResponseJson.get('errors')}" />
			<log level="info" value="responseStatus: #{#responseStatus}" />
			<if condition="#{'success'.equals(#responseStatus)}">
				<var name="responseStatus" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#getOrdersStatusSyncMetadataResponseJson, 'status')}" />
				<var name="dataJsonObject" value="#{#getOrdersStatusSyncMetadataResponseJson.get('data').getAsJsonObject()}" />
                <var name="dataString" value="#{T(com.unifier.core.utils.JsonUtils).objectToString(#dataJsonObject)}" />
                <var name="saleOrderCodeToMetadataMap" value="#{T(com.unifier.core.utils.JsonUtils).jsonToMap(#dataString)}" />
				<log level="info" value="saleOrderCodeToMetadataMap members type: #{#saleOrderCodeToMetadataMap.get('members').get('4568483954870').getClass().getName()}" />
                <var value="#{#resultItems.putAll(#saleOrderCodeToMetadataMap.get('members'))}" />
				<else>
					<log level="info" value="responseStatus: #{#responseStatus} is not success" />
				</else>
			</if>
			<else>
				<if condition="#{#getOrdersStatusSyncMetadataResponseCode == 400}">
					<log level="info" value="Error(s) in request | responseMessage: #{#responseMessage} | responseErrors: #{#responseErrors}" />
					<else>
						<log level="info" value="Error fetching orders status sync metadata" />
					</else>
				</if>
			</else>
		</if>
	</method>

    <invoke method="prepareGetOrdersStatusSyncMetadataRequestHeaders" />
    <invoke method="doGetOrdersStatusSyncMetadataRequest" />
    <invoke method="handleGetOrdersStatusSyncMetadataResponse" >
        <param name="getOrdersStatusSyncMetadataResponseCode" value="#{#getOrdersStatusSyncMetadataResponseResponseCode}" />
    </invoke>

    <log level="info" value="#{#TAG} resultItems : #{#resultItems.toString()}" />
</scraper>