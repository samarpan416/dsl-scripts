<scraper name="shopifySaleOrderStatusSyncScript" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.unicommerce.com/schema/scraper-1.0.xsd">
    <!--  Description => Uses the "cancelledSaleOrdersMap" map to set sale order's status for all sale order items , if found in the map -->
    <!--  @params   - cancelledSaleOrdersMap Map<String,Object>
                    - saleOrder - code
                                - saleOrderItems Set<SaleOrderItem> - code
      -->

    <var name="saleOrderCode" value="#{#saleOrder.code}" />

    <var name="getServiceBaseUrlResponse" value="#{new java.util.HashMap()}" />
	<invoke method="getServiceBaseUrl">
		<param name="getServiceBaseUrlResponse" value="#{#getServiceBaseUrlResponse}" />
	</invoke>
	<var name="SHOPIFY_MS_BASE_URL" value="#{#getServiceBaseUrlResponse.get('baseUrl')}" />

    <method name="prepareSaleOrderStatusSyncRequestHeaders">
        <var name="requiredHeaders" value="#{new java.util.HashMap()}" />
        <invoke method="getRequiredServiceRequestHeaders" script="shopifyUtils">
            <param name="requiredHeaders" value="#{#requiredHeaders}" />
            <param name="hostname" value="#{#hostname}" />
            <param name="locationId" value="#{#locationId}" />
            <param name="apiKey" value="#{#apiKey}" />
            <param name="password" value="#{#password}" />
            <param name="tenantCode" value="#{T(com.uniware.core.utils.UserContext).current().tenant.code}" />
            <param name="channelCode" value="#{#channel.code}" />
            <param name="channelSourceCode" value="#{#channel.sourceCode}" />
        </invoke>

        <var name="saleOrderStatusSyncRequestHeaders" value="#{new java.util.HashMap()}" />
        <var value="#{#saleOrderStatusSyncRequestHeaders.putAll(#requiredHeaders)}" />
        <var value="#{#saleOrderStatusSyncRequestHeaders.put('Content-Type', 'application/json' )}" />

        <log level="info" value="saleOrderStatusSyncRequestHeaders: #{#saleOrderStatusSyncRequestHeaders.toString()}" />
    </method>

    <method name="prepareSaleOrderStatusSyncRequestBody">
        <var name="saleOrderStatusSyncRequest" value="#{new java.util.HashMap()}" />
        <var name="statusSyncSaleOrderItems" value="#{new java.util.ArrayList()}" />
        <var value="#{#saleOrderStatusSyncRequest.put('statusSyncSaleOrderItems', #statusSyncSaleOrderItems)}" />
        <!-- TODO: Check data type -->
        <var name="shopifyOrderMetadata" value="#{#cancelledSaleOrdersMap.get(#saleOrderCode)}" />
        <log level="info" value="shopifyOrderMetadata type: #{#shopifyOrderMetadata?.getClass().getName()}" />
        <var value="#{#saleOrderStatusSyncRequest.put('shopifyOrderMetadata', #shopifyOrderMetadata)}" />

        <var name="saleOrderItemIterator" value="#{#saleOrder.saleOrderItems.iterator()}" />
        <while condition="#{#saleOrderItemIterator.hasNext()}">
            <var name="saleOrderItem" value="#{#saleOrderItemIterator.next()}" />
            <var name="saleOrderItemData" value="#{new java.util.HashMap()}" />
            <var value="#{#saleOrderItemData.put('code', #saleOrderItem.code)}" />
            <var value="#{#saleOrderItemData.put('statusCode', #saleOrderItem.statusCode)}" />
            <var value="#{#saleOrderItemData.put('cancellable', #saleOrderItem.isCancellable())}" />
            <var value="#{#saleOrderItemData.put('channelSaleOrderItemCode', #saleOrderItem.channelSaleOrderItemCode)}" />
            <var value="#{#saleOrderItemData.put('combinationIdentifier', #saleOrderItem.combinationIdentifier)}" />
            <var value="#{#saleOrderItemData.put('returned', #saleOrderItem.reversePickup != null)}" />
            <var value="#{#saleOrderItemData.put('reversePickable', #saleOrderItem.isReversePickable())}" />
            <var value="#{#statusSyncSaleOrderItems.add(#saleOrderItemData)}" />
        </while>

        <var name="saleOrderStatusSyncRequestBody" value="#{T(com.unifier.core.utils.JsonUtils).objectToString(#saleOrderStatusSyncRequest, true)}" />
        <log level="info" value="saleOrderStatusSyncRequestBody: #{#saleOrderStatusSyncRequestBody}" />
    </method>

    <method name="doSaleOrderStatusSyncRequest">
        <http method="POST" url="#{#SHOPIFY_MS_BASE_URL}/orders/#{#saleOrderCode}/status-sync" var="saleOrderStatusSyncResponse" fetchStatusCode="true">
            <headers map="#{#saleOrderStatusSyncRequestHeaders}" />
            <body>#{#saleOrderStatusSyncRequestBody}</body>
        </http>

        <log level="info" value="saleOrderStatusSyncResponse: #{#saleOrderStatusSyncResponse}" />
    </method>

    <method name="handleSaleOrderStatusSyncResponse">
        <if condition="#{#saleOrderStatusSyncResponseCode == 200}">
            <var name="saleOrderStatusSyncResponseJson" value="#{T(com.unifier.core.utils.JsonUtils).stringToJson(#saleOrderStatusSyncResponse)}" />
            <var name="responseStatus" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#saleOrderStatusSyncResponseJson, 'status')}" />
            <var name="responseMessage" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#saleOrderStatusSyncResponseJson, 'message')}" />
            <var name="responseErrors" value="#{#saleOrderStatusSyncResponseJson.get('errors')}" />
            <log level="info" value="responseStatus: #{#responseStatus}" />
            <if condition="#{'success'.equals(#responseStatus)}">
                <var name="responseStatus" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#saleOrderStatusSyncResponseJson, 'status')}" />
                <var name="wsSaleOrderItems" value="#{#saleOrderStatusSyncResponseJson.get('data')}" />
                <else>
                    <log level="info" value="responseStatus: #{#responseStatus} is not success" />
                </else>
            </if>
            <else>
                <if condition="#{#saleOrderStatusSyncResponseCode == 400}">
                    <log level="info" value="Error(s) in request | responseMessage: #{#responseMessage} | responseErrors: #{#responseErrors}" />
                    <else>
                        <log level="info" value="Error fetching orders status sync metadata" />
                    </else>
                </if>
            </else>
        </if>
    </method>

    <method name="prepareSaleOrderStatusSyncXML">
        <var name="wsSaleOrderItemsItr" value="#{#wsSaleOrderItems.iterator()}" />
        <while condition="#{#wsSaleOrderItemsItr.hasNext()}">
            <var name="wsSaleOrderItem" value="#{#wsSaleOrderItemsItr.next()}" />
            <startTag name="SaleOrderItem" />
            <valueTag name="Code" value="#{#wsSaleOrderItem.get('code').getAsString()}" />
            <valueTag name="StatusCode" value="#{#wsSaleOrderItem.get('statusCode').getAsString()}" />
            <endTag name="SaleOrderItem" />
        </while>
    </method>

    <invoke method="prepareSaleOrderStatusSyncRequestHeaders" />
    <invoke method="prepareSaleOrderStatusSyncRequestBody" />
    <invoke method="doSaleOrderStatusSyncRequest" />
    <invoke method="handleSaleOrderStatusSyncResponse">
        <param name="saleOrderStatusSyncResponseCode" value="#{#saleOrderStatusSyncResponseResponseCode}" />
    </invoke>

    <startTag name="SaleOrderItems" />
        <if condition="#{#wsSaleOrderItems == null or #wsSaleOrderItems.isJsonNull() or !#wsSaleOrderItems.isJsonArray()}">
            <log level="info" value="data is null in saleOrderStatusSyncResponse" />
            <else>
                <invoke method="prepareSaleOrderStatusSyncXML">
                    <param name="wsSaleOrderItems" value="#{#wsSaleOrderItems.getAsJsonArray()}" />
                </invoke>
            </else>
        </if>
    <endTag name="SaleOrderItems" />

</scraper>