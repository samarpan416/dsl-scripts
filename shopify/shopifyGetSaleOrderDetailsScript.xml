<scraper name="shopifyGetSaleOrderDetailsScript" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.unicommerce.com/schema/scraper-1.0.xsd" cachehttpclient="false">

	<method name="populateCustomFields">
		<var name="customFieldMap" value="#{new java.util.HashMap()}" />
		<if condition="#{#customFieldsCustomization == null or ''.equals(#customFieldsCustomization)}">
			<var name="customFieldsCustomization" value="[]" />
		</if>
		<var name="customFieldsCustomizationMap" value="#{T(com.unifier.core.utils.JsonUtils).stringToJson(#customFieldsCustomization)}" />
		<var name="customFieldsCustomizationMapIterator" value="#{#customFieldsCustomizationMap.getAsJsonArray().iterator()}" />
		<while condition="#{#customFieldsCustomizationMapIterator.hasNext()}">
			<var name="customField" value="#{#customFieldsCustomizationMapIterator.next()}" />
			<var name="customFieldEntrySet" value="#{#customField.entrySet().iterator()}" />
			<var name="entry" value="#{#customFieldEntrySet.next()}" />
			<try>
				<var name="customFieldValue" value="#{T(com.unifier.scraper.sl.expression.SLExpression).compile(#entry.getValue()).evaluate(T(com.unifier.scraper.sl.runtime.ScriptExecutionContext).current())}" />
				<var value="#{#customFieldMap.put(#entry.getKey(),#customFieldValue)}" />
				<catch>
					<!-- TODO Stop execution or NOT -->
					<log level="info" value="Error with CustomField : #{#entry.getKey()}" />
				</catch>
			</try>
		</while>
		<startTag name="CustomFields" />
		<var name="customFieldMapIterator" value="#{#customFieldMap.entrySet().iterator()}" />
		<while condition="#{#customFieldMapIterator.hasNext()}">
			<var name="customFieldMapElement" value="#{#customFieldMapIterator.next()}" />
			<var name="customFieldMapKey" value="#{#customFieldMapElement.getKey()}" />
			<var name="customFieldMapValue" value="#{#customFieldMapElement.getValue()}" />
			<log level="info" value="customFieldMapElement : #{#customFieldMapElement.toString()}" />
			<if condition="#{#customFieldMapKey != null and #customFieldMapValue != null}">
				<startTag name="CustomField">
					<attribute name="name" value="#{#customFieldMapKey}" />
					<attribute name="value" value="#{#customFieldMapValue.replaceAll('&quot;','')}" />
				</startTag>
				<endTag name="CustomField" />
			</if>
		</while>
		<endTag name="CustomFields" />
	</method>

	<method name="addAddressDetail">

		<!-- name = firstName + lastName -->
		<var name="name" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#address, 'first_name')} #{T(com.unifier.core.utils.StringUtils).getNotNullValue(T(com.unifier.core.utils.JsonUtils).getAsString(#address, 'last_name'))}" />
		<!-- Company  name -->
		<try>
			<var name="company" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#address, 'company').replaceAll(&quot;\P{Print}&quot;, &quot;&quot;)}" />
			<catch>
				<var name="company" value="" />
			</catch>
		</try>
		<!-- Address line1 = companyName + addressLine1 -->
		<try>
			<var name="addressLine1" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#address, 'address1').replaceAll(&quot;\P{Print}&quot;, &quot;&quot;)}" />
			<catch>
				<var name="addressLine1" value="" />
			</catch>
		</try>
		<var name="addressLine1" value="#{T(com.unifier.core.utils.StringUtils).isNotBlank(#company)? (#company +', '+ #addressLine1) : #addressLine1}" />
		<!-- Address line2 -->
		<try>
			<var name="addressLine2" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#address, 'address2')}" />
			<catch>
				<var name="addressLine2" value="" />
			</catch>
		</try>
		<if condition="#{T(com.unifier.core.utils.StringUtils).isNotBlank(#addressLine2)}">
			<var name="addressLine2" value="#{#addressLine2.replaceAll(&quot;\P{Print}&quot;, &quot;&quot;)}" />
		</if>

		<!-- pincode [contains only letters and digit ] -->
		<var name="pincode" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#address, 'zip')}" />
		<var name="pincode" value="#{#pincode != null ? T(com.unifier.core.utils.StringUtils).removeNonWordChars(#pincode) : null}" />
		<var name="city" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#address, 'city')}" />
		<var name="state" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#address, 'province')}" />
		<var name="country" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#address, 'country')}" />

		<!-- if stateCodeRequired false weâ€™ll make city as state else work as pervious -->
		<log level="debug" value="[SHOPIFY] stateCodeRequired : #{#stateCodeRequired}" />
		<if condition="#{T(com.unifier.core.utils.StringUtils).isBlank(#state) and !#stateCodeRequired}">
			<var name="state" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#address, 'city')}" />
			<else>
				<!-- If state is blank and country is INDIA than get state by hitting flipkart API -->
				<if condition="#{T(com.unifier.core.utils.StringUtils).isBlank(#state)} and #country.equalsIgnoreCase('india')}">
					<http method="post" url="https://www.flipkart.com/xhr/getCityAndStateForPinCode" var="getStateResponse">
						<param name="pincode" value="#{#pincode}" />
					</http>
					<var name="getStateJson" value="#{T(com.unifier.core.utils.JsonUtils).stringToJson(#getStateResponse)}" />
					<var name="state" value="#{#getStateJson.get('data') != '' ? #getStateJson.get('data').get('state').getAsString() : ''}" />
				</if>
			</else>
		</if>

		<!-- Phone Number. If phoneNumber is empty that set it to default "9999999999" -->
		<var name="phone" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#address, 'phone')}" />
		<var name="phone" value="#{T(com.unifier.core.utils.StringUtils).isNotBlank(#phone) ? #phone : '9999999999'}" />

		<!-- map above field to uniware field -->
		<startTag name="Address">
			<attribute name="id" value="#{#addressId}" />
		</startTag>
		<valueTag name="Name" value="#{#name}" cdata="true" />
		<valueTag name="AddressLine1" value="#{#addressLine1}" cdata="true" />
		<valueTag name="AddressLine2" value="#{#addressLine2}" cdata="true" />
		<valueTag name="City" value="#{#city}" cdata="true" />
		<valueTag name="State" value="#{#state}" cdata="true" />
		<valueTag name="Pincode" value="#{#pincode}" cdata="true" />
		<valueTag name="Country" value="#{#country}" cdata="true" />
		<valueTag name="Phone" value="#{#phone}" cdata="true" />
		<endTag name="Address" />
	</method>

	<method name="addSaleOrderItem">
		<startTag name="SaleOrderItem" />
		<valueTag name="Code" value="#{#saleOrderItemCode}" />
		<valueTag name="ChannelSaleOrderItemCode" value="#{#channelSaleOrderItemCode}" />
		<valueTag name="ItemSKU" value="#{#itemSkuCode}" cdata="true" />
		<valueTag name="ChannelProductId" value="#{#channelProductId}" cdata="true" />
		<valueTag name="ItemName" value="#{#itemName}" cdata="true" />
		<valueTag name="ShippingMethodCode" value="STD" />
		<!-- <valueTag name="GiftMessage" value="#{#giftMessage}" /> -->
		<var name="productPrice" value="#{T(com.unifier.core.utils.NumberUtils).newBigDecimal(#itemJson.get('price').getAsString())}" />
		<valueTag name="TotalPrice" value="#{#productPrice}" />
		<valueTag name="SellingPrice" value="#{#productPrice}" />
		<try>
			<var name="voucherCode" value="#{#saleOrderJson.get('discount_codes').get(0).get('code').getAsString()}" />
			<if condition="#{#voucherCode.length() > 45 }">
				<var name="voucherCode" value="#{#voucher.substring(0,45)}" />
			</if>
			<valueTag name="VoucherCode" value="#{#voucherCode}" cdata="true" />
			<catch>
				<log level="debug" value="[SHOPIFY] EMPTY discount_codes " />
			</catch>
		</try>

		<if condition="#{#channel.packageType == 'FIXED'}">
			<valueTag name="PacketNumber" value="1" />
			<else>
				<valueTag name="PacketNumber" value="0" />
			</else>
		</if>
		<endTag name="SaleOrderItem" />
	</method>

	<method name="addSaleOrder">
		<startTag name="CreateSaleOrderRequest">
			<attribute name="xmlns" value="http://uniware.unicommerce.com/services/" />
		</startTag>
		<startTag name="SaleOrder" />
		<valueTag name="Code" value="#{#saleOrderCode}" />
		<valueTag name="CashOnDelivery" value="#{#cashOnDelivery}" />
		<log level="debug" value="prefix: #{#prefix}" />
		<if condition="#{#prefix.equalsIgnoreCase('true')}">
			<var name="displayOrderCode" value="#{#saleOrderJson.get('name').getAsString()}" />
			<else>
				<var name="displayOrderCode" value="#{#saleOrderJson.get('order_number').getAsString()}" />
			</else>
		</if>
		<valueTag name="DisplayOrderCode" value="#{#displayOrderCode}" />
		<!-- <if condition="#{!#saleOrderJson.get('checkout_id').isJsonNull()}">
			<valueTag name="AdditionalInfo" value="#{#saleOrderJson.get('checkout_id').getAsString()}" />
		</if> -->
		<if condition="#{!#saleOrderJson.get('checkout_id').isJsonNull()}">
			<try>
				<valueTag name="AdditionalInfo" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#saleOrderJson, 'checkout_id')}" />
				<valueTag name="TransactionId" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#saleOrderJson, 'checkout_id')}" />
				<valueTag name="PaymentMode" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#saleOrderJson, 'payment_gateway_names')}" />
				<valueTag name="TransactionDate" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#saleOrderJson, 'created_at')}" />
				<!-- Added from testPaymentDetails -->
				<valueTag name="AmountPaid" value="#{#saleOrderJson.get('shop_money').get('amount').getAsString()}" />
				<catch>
					<log level="info" value="#{#TAG} can't save AdditionalInfo into Map" />
				</catch>
			</try>
		</if>
		<var name="shopifyDatePattern" value="yyyy-MM-dd'T'HH:mm:ss" />
		<var name="uniwareDatePattern" value="yyyy-MM-dd'T'HH:mm:ss" />
		<var name="shopifyDate" value="#{T(com.unifier.core.utils.DateUtils).stringToDate(#saleOrderJson.get('created_at').getAsString(), #shopifyDatePattern)}" />
		<log level="debug" value="#{#shopifyDate.toString()}" />
		<valueTag name="DisplayOrderDateTime" value="#{T(com.unifier.core.utils.DateUtils).dateToString(#shopifyDate, #uniwareDatePattern)}+05:30" cdata="true" />
		<var name="notificationMobile" value="#{T(com.unifier.core.utils.ValidatorUtils).getValidMobileOrNull(T(com.unifier.core.utils.JsonUtils).getAsString(#billingAddress, 'phone'))}" />
		<if condition="#{#notificationMobile !=null}">
			<valueTag name="NotificationMobile" value="#{#notificationMobile}" />
		</if>
		<valueTag name="NotificationEmail" value="#{#saleOrderJson.get('email').getAsString()}" cdata="true" />
		<valueTag name="CurrencyCode" value="#{#saleOrderJson.get('currency').getAsString()}" />
		<var name="discount" value="#{T(com.unifier.core.utils.NumberUtils).newBigDecimal(#saleOrderJson.get('total_discounts').getAsString())}" />
		<log level="debug" value="TOTAL DISCOUNT:#{#discount}" />
		<log level="debug" value="NotificationEmail:#{#NotificationEmail}" />

		<var name="shippingChargesIterator" value="#{#saleOrderJson.get('shipping_lines').getAsJsonArray().iterator()}" />
		<var name="shippingCharges" value="#{T(com.unifier.core.utils.NumberUtils).newBigDecimal(0.00)}" />
		<if condition="#{#shippingChargesIterator.hasNext()}">
			<var name="charge" value="#{#shippingChargesIterator.next()}" />
			<var name="title" value="#{#charge.get('title').getAsString()}" />
			<if condition="#{#title.contains('Cash on Delivery')}">
				<var name="codCharges" value="#{T(com.unifier.core.utils.NumberUtils).newBigDecimal(#charge.get('price').getAsString())}" />
				<else>
					<var name="shippingCharges" value="#{T(com.unifier.core.utils.NumberUtils).newBigDecimal(#charge.get('price').getAsString())}" />
				</else>
			</if>
		</if>

		<valueTag name="TotalShippingCharges" value="#{#shippingCharges}" />
		<valueTag name="TotalCashOnDeliveryCharges" value="#{#codCharges!=null ? #codCharges: T(com.unifier.core.utils.NumberUtils).newBigDecimal(0.00)}" />
		<var name="prepaidAmount" value="#{#giftDiscount.add(#partiallyPaidAmount)}" />
		
		<var name="subtotal" value="#{T(com.unifier.core.utils.NumberUtils).newBigDecimal(#saleOrderJson.get('total_line_items_price').getAsString())}" />
		<var name="totalOrderAmount" value="#{#shippingCharges.add(#subtotal)}" />
		<if condition="#{(#prepaidAmount.add(#discount)) &gt; #totalOrderAmount}">
			<var name="prepaidAmount" value="#{#totalOrderAmount.subtract(#discount)}" />
		</if>

		<var name="FLITSValue" value="#{T(com.unifier.core.utils.NumberUtils).newBigDecimal(0.00)}" />
		<if condition="#{null != #saleOrderJson.get('discount_codes')}">
			<var name="discountCodeIterator" value="#{#saleOrderJson.get('discount_codes').getAsJsonArray().iterator()}" />
			<if condition="#{#discountCodeIterator.hasNext()}">
				<var name="discountCode" value="#{#discountCodeIterator.next()}" />
				<var name="discountCodeStr" value="#{#discountCode.get('code').getAsString()}" />
				<if condition="#{#discountCodeStr.contains('FLITS')}">
					<var name="discountCodeValue" value="#{T(com.unifier.core.utils.NumberUtils).newBigDecimal(#discountCode.get('amount').getAsString())}" />
					<var name="FLITSValue" value="#{#FLITSValue.add(#discountCodeValue)}" />
					<var name="discount" value="#{#discount.subtract(#discountCodeValue)}" />
				</if>
			</if>
		</if>

		<var name="prepaidAmount" value="#{#prepaidAmount.add(#FLITSValue)}" />

		<valueTag name="TotalDiscount" value="#{#discount}" />
		<valueTag name="TotalPrepaidAmount" value="#{#prepaidAmount}" />
		<log level="info" value="#{'Importing Order - Code:['+ #saleOrderCode +']'}" />
		<log level="debug" value="TOTAL Prepaid: #{#prepaidAmount}" />
		<var name="customerName" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#billingAddress, 'first_name')} #{T(com.unifier.core.utils.StringUtils).getNotNullValue(T(com.unifier.core.utils.JsonUtils).getAsString(#billingAddress, 'last_name'))}" />

		<startTag name="Addresses" />

		<var name="addressId" value="1" />
		<var name="address" value="#{#billingAddress}" />
		<invoke method="addAddressDetail" />
		<if condition="#{#billingAddress != #shippingAddress}">
			<var name="addressId" value="2" />
			<var name="address" value="#{#shippingAddress}" />
			<invoke method="addAddressDetail" />
		</if>
		<endTag name="Addresses" />

		<startTag name="BillingAddress">
			<attribute name="ref" value="1" />
		</startTag>
		<endTag name="BillingAddress" />

		<startTag name="ShippingAddress">
			<attribute name="ref" value="#{#billingAddress != #shippingAddress ? '2' : '1'}" />
		</startTag>
		<endTag name="ShippingAddress" />

		<startTag name="SaleOrderItems" />
		<var name="lineItemsIterator" value="#{#saleOrderJson.get('line_items').getAsJsonArray().iterator()}" />
		<while condition="#{#lineItemsIterator.hasNext()}">
			<var name="itemJson" value="#{#lineItemsIterator.next()}" />
			<var name="itemName" value="#{#itemJson.get('name').getAsString()}" />
			<if condition="#{#itemName.length() &gt; 199}">
				<var name="itemName" value="#{#itemName.substring(0, 199)}" />
			</if>
			<var name="itemSkuCode" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#itemJson, 'sku')}" />
			<var name="channelProductId" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#itemJson, 'product_id')}" />
			<var name="variantId" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#itemJson, 'variant_id')}" />
			<var name="giftMessage" value="#{T(com.unifier.core.utils.JsonUtils).objectToString(#itemJson.get('properties'))}" />
			<if condition="#{T(com.unifier.core.utils.StringUtils).isNotBlank(#variantId)}">
				<var name="channelProductId" value="#{#channelProductId}-#{#variantId}" />
			</if>
			<if condition="#{T(com.unifier.core.utils.StringUtils).isBlank(#channelProductId)}">
				<var name="channelProductId" value="#{#itemName}" />
				<if condition="#{#channelProductId.length() &gt; 127}">
					<var name="channelProductId" value="#{#channelProductId.substring(0, 127)}" />
				</if>
			</if>
			<if condition="#{T(com.unifier.core.utils.StringUtils).isBlank(#itemSkuCode)}">
				<var name="itemSkuCode" value="#{#channelProductId}" />
			</if>
			<var name="itemCount" value="#{0}" />
			<var name="productQuantity" value="#{#itemJson.get('quantity').getAsInt()}" />
			<var name="channelSaleOrderItemCode" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#itemJson, 'id')}" />
			<if condition="#{#productQuantity == 1}">
				<var name="saleOrderItemCode" value="#{#channelSaleOrderItemCode}" />
				<invoke method="addSaleOrderItem" />
				<else>
					<while condition="#{#itemCount &lt; #productQuantity}">
						<var name="saleOrderItemCode" value="#{#channelSaleOrderItemCode + '-' + #itemCount}" />
						<invoke method="addSaleOrderItem" />
						<var name="itemCount" value="#{#itemCount + 1}" />
					</while>
				</else>
			</if>
		</while>
		<endTag name="SaleOrderItems" />
		<!-- Custom Fields Customizations | AE-968 -->
		<invoke method="populateCustomFields" />
		<endTag name="SaleOrder" />
		<endTag name="CreateSaleOrderRequest" />
	</method>

	<log level="debug" value="#{#TAG} SaleOrderDetailElement : #{#saleOrderDetailElement.toString()}" />
	<var name="saleOrderJson" value="#{T(com.unifier.core.utils.JsonUtils).stringToJson(#saleOrderDetailElement)}" />
	<var name="cashOnDelivery" value="#{#saleOrderElement.attribute('cashOnDelivery')}" />
	<var name="giftDiscount" value="#{T(com.unifier.core.utils.NumberUtils).newBigDecimal(#saleOrderElement.attribute('giftDiscount'))}" />
	<var name="partiallyPaidAmount" value="#{T(com.unifier.core.utils.NumberUtils).newBigDecimal(#saleOrderElement.attribute('partiallyPaidAmount'))}" />

	<var name="defaultAddress" value="#{#saleOrderJson.get('customer') != null ? #saleOrderJson.get('customer').get('default_address') : null}" />
	<var name="shippingAddress" value="#{#saleOrderJson.get('shipping_address') != null ? #saleOrderJson.get('shipping_address'): #defaultAddress}" />
	<var name="billingAddress" value="#{#saleOrderJson.get('billing_address') != null ? #saleOrderJson.get('billing_address'): #defaultAddress != null ? #defaultAddress: #shippingAddress}" />
	<if condition="#{#billingAddress == null or #shippingAddress == null}">
		<scriptError message="Billing/Shipping addresses not found" />
	</if>

	<invoke method="addSaleOrder" />

</scraper>