<scraper name="shopifyGetSaleOrderDetailsScript" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.unicommerce.com/schema/scraper-1.0.xsd" cachehttpclient="false">
	<log level="debug" value="#{#TAG} SaleOrderDetailElement : #{#saleOrderDetailElement.toString()}" />

	<var name="SHOPIFY_MS_BASE_URL" value="https://3b03-103-248-87-34.in.ngrok.io/shopify" />

	<method name="prepareGetWsSaleOrderRequestBody">
		<var name="getWsSaleOrderRequestMap" value="#{new java.util.HashMap()}" />
		<var name="configurationParameters" value="#{new java.util.HashMap()}" />
		<var name="connectorParameters" value="#{new java.util.HashMap()}" />

		<var value="#{#configurationParameters.put('applicableProvinceCodes', #applicableProvinceCodes)}" />
		<var value="#{#configurationParameters.put('stateCodeRequired', #stateCodeRequired)}" />
		<var value="#{#configurationParameters.put('customFieldsCustomization', #customFieldsCustomization)}" />
		<var value="#{#configurationParameters.put('enablePOS', #enablePOS)}" />

		<var value="#{#connectorParameters.put('apiKey', #apiKey)}" />
		<var value="#{#connectorParameters.put('hostname', #hostname)}" />
		<var value="#{#connectorParameters.put('password', #password)}" />
		<var value="#{#connectorParameters.put('accessToken', #accessToken)}" />
		<var value="#{#connectorParameters.put('prefix', #prefix)}" />

		<var value="#{#getWsSaleOrderRequestMap.put('orderId', #saleOrderCode)}" />
		<var value="#{#getWsSaleOrderRequestMap.put('order', T(com.unifier.core.utils.JsonUtils).jsonToMap(#saleOrderDetailElement))}" />
		<var value="#{#getWsSaleOrderRequestMap.put('configurationParameters', #configurationParameters)}" />
		<var value="#{#getWsSaleOrderRequestMap.put('connectorParameters', #connectorParameters)}" />

		<var name="getWsSaleOrderRequestBody" value="#{T(com.unifier.core.utils.JsonUtils).objectToString(#getWsSaleOrderRequestMap, true)}" />
		<log level="info" value="getWsSaleOrderRequestBody: #{#getWsSaleOrderRequestBody}" />
	</method>

	<method name="prepareGetWsSaleOrderRequestHeaders">
		<var name="tenantCode" value="#{T(com.uniware.core.utils.UserContext).current().tenant.code}" />

		<var name="getWsSaleOrderRequestHeaders" value="#{new java.util.HashMap()}" />
		<var value="#{#getWsSaleOrderRequestHeaders.put('hostname', #hostname )}" />
		<var value="#{#getWsSaleOrderRequestHeaders.put('location_id', #locationId )}" />
		<var value="#{#getWsSaleOrderRequestHeaders.put('username', #apiKey )}" />
		<var value="#{#getWsSaleOrderRequestHeaders.put('password', #password )}" />
		<var value="#{#getWsSaleOrderRequestHeaders.put('tenant_code', #tenantCode )}" />
		<var value="#{#getWsSaleOrderRequestHeaders.put('location_id', #locationId )}" />
		<var value="#{#getWsSaleOrderRequestHeaders.put('TenantCode', #tenantCode )}" />
		<var value="#{#getWsSaleOrderRequestHeaders.put('ChannelCode', #channel.code )}" />
		<var value="#{#getWsSaleOrderRequestHeaders.put('SourceCode', #channel.sourceCode )}" />
		<var value="#{#getWsSaleOrderRequestHeaders.put('Content-Type', 'application/json' )}" />

		<log level="info" value="getWsSaleOrderRequestHeaders: #{#getWsSaleOrderRequestHeaders.toString()}" />
	</method>

	<method name="doGetWsSaleOrderRequest">
		<http method="POST" url="#{#SHOPIFY_MS_BASE_URL}/ws-sale-order" var="getWsSaleOrderResponse" fetchStatusCode="true">
			<headers map="#{#getWsSaleOrderRequestHeaders}" />
			<body>#{#getWsSaleOrderRequestBody}</body>
		</http>

		<log level="info" value="getWsSaleOrderResponse: #{#getWsSaleOrderResponse}" />
	</method>

	<method name="prepareCustomFieldXML">
		<startTag name="CustomFields" />
		<startTag name="CustomField">
			<attribute name="name" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#customField, 'name')}" />
			<attribute name="value" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#customField, 'value')}" />
		</startTag>
		<endTag name="CustomField" />
		<endTag name="CustomFields" />
	</method>

	<method name="prepareAddressXML">
		<startTag name="Address">
			<attribute name="id" value="#{#address.get('id').getAsString()}" />
		</startTag>
		<valueTag name="Name" value="#{#address.get('name').getAsString()}" cdata="true" />
		<valueTag name="AddressLine1" value="#{#address.get('addressLine1').getAsString()}" cdata="true" />
		<valueTag name="AddressLine2" value="#{#address.get('addressLine2').getAsString()}" cdata="true" />
		<valueTag name="City" value="#{#address.get('city').getAsString()}" cdata="true" />
		<valueTag name="State" value="#{#address.get('state').getAsString()}" cdata="true" />
		<valueTag name="Pincode" value="#{#address.get('pincode').getAsString()}" cdata="true" />
		<valueTag name="Country" value="#{#address.get('country').getAsString()}" cdata="true" />
		<valueTag name="Phone" value="#{#address.get('phone').getAsString()}" cdata="true" />
		<endTag name="Address" />
	</method>

	<method name="prepareSaleOrderItemXML">
		<startTag name="SaleOrderItem" />
		<valueTag name="Code" value="#{#saleOrderItem.get('code').getAsString()}" />
		<valueTag name="ChannelSaleOrderItemCode" value="#{#saleOrderItem.get('channelSaleOrderItemCode').getAsString()}" />
		<valueTag name="ItemSKU" value="#{#saleOrderItem.get('itemSku').getAsString()}" cdata="true" />
		<valueTag name="ChannelProductId" value="#{#saleOrderItem.get('channelProductId').getAsString()}" cdata="true" />
		<valueTag name="ItemName" value="#{#saleOrderItem.get('itemName').getAsString()}" cdata="true" />
		<valueTag name="ShippingMethodCode" value="#{#saleOrderItem.get('shippingMethodCode').getAsString()}" />
		<valueTag name="GiftMessage" value="#{#saleOrderItem.get('giftMessage').getAsString()}" cdata="true" />
		<valueTag name="Discount" value="#{#saleOrderItem.get('discount').getAsBigDecimal()}" />
		<valueTag name="TotalPrice" value="#{#saleOrderItem.get('totalPrice').getAsBigDecimal()}" />
		<valueTag name="SellingPrice" value="#{#saleOrderItem.get('sellingPrice').getAsBigDecimal()}" />
		<valueTag name="VoucherCode" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#saleOrderItem, 'voucherCode')}" cdata="true" />
		<valueTag name="PacketNumber" value="#{#saleOrderItem.get('packetNumber').getAsInt()}" />
		<endTag name="SaleOrderItem" />
	</method>

	<method name="prepareCreateSaleOrderRequestXML">
		<startTag name="CreateSaleOrderRequest">
			<attribute name="xmlns" value="http://uniware.unicommerce.com/services/" />
		</startTag>
		<startTag name="SaleOrder" />
		<valueTag name="Code" value="#{#wsSaleOrder.get('code').getAsString()}" />
		<valueTag name="CashOnDelivery" value="#{#wsSaleOrder.get('cashOnDelivery').getAsBoolean()}" />
		<valueTag name="DisplayOrderCode" value="#{#wsSaleOrder.get('displayOrderCode').getAsString()}" />
		<valueTag name="AdditionalInfo" value="#{#wsSaleOrder.get('additionalInfo').getAsString()}" />
		<valueTag name="TransactionId" value="#{#wsSaleOrder.get('transactionId').getAsString()}" />
		<valueTag name="PaymentMode" value="#{#wsSaleOrder.get('paymentMode').getAsString()}" />
		<valueTag name="TransactionDate" value="#{#wsSaleOrder.get('transactionDate').getAsString()}" />
		<valueTag name="DisplayOrderDateTime" value="#{#wsSaleOrder.get('displayOrderDateTime').getAsString()}" cdata="true" />
		<valueTag name="NotificationMobile" value="#{#wsSaleOrder.get('notificationMobile').getAsString()}" />
		<valueTag name="NotificationEmail" value="#{#wsSaleOrder.get('notificationEmail').getAsString()}" cdata="true" />
		<valueTag name="CurrencyCode" value="#{#wsSaleOrder.get('currencyCode').getAsString()}" />
		<valueTag name="CustomerGSTIN" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#wsSaleOrder, 'customerGSTIN')}" />
		<valueTag name="TotalShippingCharges" value="#{#wsSaleOrder.get('totalShippingCharges').getAsBigDecimal()}" />
		<valueTag name="TotalCashOnDeliveryCharges" value="#{#wsSaleOrder.get('totalCashOnDeliveryCharges').getAsBigDecimal()}" />
		<valueTag name="TotalPrepaidAmount" value="#{#wsSaleOrder.get('totalPrepaidAmount').getAsBigDecimal()}" />

		<startTag name="Addresses" />
		<var name="addressesItr" value="#{#wsSaleOrder.get('addresses').getAsJsonArray().iterator()}" />
		<while condition="#{#addressesItr.hasNext()}">
			<var name="address" value="#{#addressesItr.next()}" />
			<invoke method="prepareAddressXML">
				<param name="address" value="#{#address}" />
			</invoke>
		</while>
		<endTag name="Addresses" />

		<startTag name="BillingAddress">
			<attribute name="ref" value="#{#wsSaleOrder.get('billingAddress').get('referenceId').getAsString()}" />
		</startTag>
		<endTag name="BillingAddress" />

		<startTag name="ShippingAddress">
			<attribute name="ref" value="#{#wsSaleOrder.get('shippingAddress').get('referenceId').getAsString()}" />
		</startTag>
		<endTag name="ShippingAddress" />

		<startTag name="SaleOrderItems" />

		<var name="saleOrderItemsItr" value="#{#wsSaleOrder.get('saleOrderItems').getAsJsonArray().iterator()}" />
		<while condition="#{#saleOrderItemsItr.hasNext()}">
			<var name="saleOrderItem" value="#{#saleOrderItemsItr.next()}" />
			<invoke method="prepareSaleOrderItemXML">
				<param name="saleOrderItem" value="#{#saleOrderItem}" />
			</invoke>
		</while>
		<endTag name="SaleOrderItems" />
		<if condition="#{#wsSaleOrder.get('totalDiscount') != null and !#wsSaleOrder.get('totalDiscount').isJsonNull()}" >
			<valueTag name="TotalDiscount" value="#{#wsSaleOrder.get('totalDiscount').getAsBigDecimal()}" />
		</if>
		<var name="customFieldValuesItr" value="#{#wsSaleOrder.get('customFieldValues').getAsJsonArray().iterator()}" />
		<while condition="#{#customFieldValuesItr.hasNext()}">
			<var name="customField" value="#{#customFieldValuesItr.next()}" />
			<invoke method="prepareCustomFieldXML">
				<param name="customField" value="#{#customField}" />
			</invoke>
		</while>

		<endTag name="SaleOrder" />
		<endTag name="CreateSaleOrderRequest" />
	</method>

	<method name="handleGetWsSaleOrderResponse">
		<if condition="#{#getWsSaleOrderResponseCode == 200}">
			<var name="getWsSaleOrderResponseJson" value="#{T(com.unifier.core.utils.JsonUtils).stringToJson(#getWsSaleOrderResponse)}" />
			<var name="responseStatus" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#getWsSaleOrderResponseJson, 'status')}" />
			<var name="responseMessage" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#getWsSaleOrderResponseJson, 'message')}" />
			<var name="responseErrors" value="#{#getWsSaleOrderResponseJson.get('errors')}" />
			<log level="info" value="responseStatus: #{#responseStatus}" />
			<if condition="#{'success'.equals(#responseStatus)}">
				<var name="responseStatus" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#getWsSaleOrderResponseJson, 'status')}" />
				<var name="wsSaleOrder" value="#{#getWsSaleOrderResponseJson.get('data')}" />
				<if condition="#{#wsSaleOrder != null}">
					<invoke method="prepareCreateSaleOrderRequestXML">
						<param name="wsSaleOrder" value="#{#wsSaleOrder}" />
					</invoke>
					<else>
						<log level="info" value="wsSaleOrder is null" />
					</else>
				</if>
				<else>
					<log level="info" value="responseStatus: #{#responseStatus} is not success" />
				</else>
			</if>
			<else>
				<if condition="#{#getWsSaleOrderResponseCode == 400}">
					<log level="info" value="Error(s) in request payload | responseMessage: #{#responseMessage} | responseErrors: #{#responseErrors}" />
					<else>
						<log level="info" value="Error fetching wsSaleOrder for #{#saleOrderCode}" />
					</else>
				</if>
			</else>
		</if>
	</method>

	<invoke method="prepareGetWsSaleOrderRequestBody" />
	<invoke method="prepareGetWsSaleOrderRequestHeaders" />
	<invoke method="doGetWsSaleOrderRequest">
		<param name="getWsSaleOrderRequestBody" value="#{#getWsSaleOrderRequestBody}" />
		<param name="getWsSaleOrderRequestHeaders" value="#{#getWsSaleOrderRequestHeaders}" />
	</invoke>
	<invoke method="handleGetWsSaleOrderResponse">
		<param name="getWsSaleOrderResponse" value="#{#getWsSaleOrderResponse}" />
		<param name="getWsSaleOrderResponseCode" value="#{#getWsSaleOrderResponseResponseCode}" />
	</invoke>
</scraper>