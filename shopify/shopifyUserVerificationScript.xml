<scraper name="shopifyUserVerificationScript" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://www.unicommerce.com/schema/scraper-1.0.xsd" cachehttpclient="false">
    <var name="getServiceBaseUrlResponse" value="#{new java.util.HashMap()}" />
    <invoke method="getServiceBaseUrl" script="shopifyUtils">
        <param name="getServiceBaseUrlResponse" value="#{#getServiceBaseUrlResponse}" />
    </invoke>
    <var name="SHOPIFY_MS_BASE_URL" value="#{#getServiceBaseUrlResponse.get('baseUrl')}" />

    <method name="prepareVerifyConnectorsHeaders">
        <var name="requiredHeaders" value="#{new java.util.HashMap()}" />
        <invoke method="getRequiredServiceRequestHeaders" script="shopifyUtils">
            <param name="requiredHeaders" value="#{#requiredHeaders}" />
            <param name="hostname" value="#{#hostname}" />
            <param name="locationId" value="#{#locationId}" />
            <param name="apiKey" value="#{#apiKey}" />
            <param name="password" value="#{#password}" />
            <param name="tenantCode" value="#{T(com.uniware.core.utils.UserContext).current().tenant.code}" />
            <param name="channelCode" value="#{#channel.code}" />
            <param name="channelSourceCode" value="#{#channel.sourceCode}" />
        </invoke>

        <var name="verifyConnectorsRequestHeaders" value="#{new java.util.HashMap()}" />
        <var value="#{#verifyConnectorsRequestHeaders.putAll(#requiredHeaders)}" />
        <var value="#{#verifyConnectorsRequestHeaders.put('Content-Type', 'application/json' )}" />

        <log level="info" value="verifyConnectorsRequestHeaders: #{#verifyConnectorsRequestHeaders.toString()}" />
    </method>

    <method name="prepareVerifyConnectorsBody">
        <var name="verifyConnectorsRequest" value="#{new java.util.HashMap()}" />
        <var name="statusSyncSaleOrderItems" value="#{new java.util.ArrayList()}" />
        <var value="#{#verifyConnectorsRequest.put('locationId', #locationId)}" />
        <var value="#{#verifyConnectorsRequest.put('hostname', #hostname)}" />
        <var value="#{#verifyConnectorsRequest.put('password', #password)}" />
        <var value="#{#verifyConnectorsRequest.put('apiKey', #apiKey)}" />
        <var value="#{#verifyConnectorsRequest.put('prefix', #prefix)}" />
        <var value="#{#verifyConnectorsRequest.put('accessToken', #accessToken)}" />

        <var name="verifyConnectorsRequestBody" value="#{T(com.unifier.core.utils.JsonUtils).objectToString(#verifyConnectorsRequest, true)}" />
        <log level="info" value="verifyConnectorsRequestBody: #{#verifyConnectorsRequestBody}" />
    </method>

    <method name="doVerifyConnectorsRequest">
        <http method="POST" url="#{#SHOPIFY_MS_BASE_URL}/connectors/verify" var="verifyConnectorsResponse" fetchStatusCode="true">
            <headers map="#{#verifyConnectorsRequestHeaders}" />
            <body>#{#verifyConnectorsRequestBody}</body>
        </http>

        <log level="info" value="verifyConnectorsResponse: #{#verifyConnectorsResponse}" />
    </method>

    <method name="handleVerifyConnectorsResponse">
        <var name="verifyConnectorsResponseJson" value="#{T(com.unifier.core.utils.JsonUtils).stringToJson(#verifyConnectorsResponse)}" />
        <var name="responseStatus" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#verifyConnectorsResponseJson, 'status')}" />
        <var name="responseMessage" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#verifyConnectorsResponseJson, 'message')}" />
        <var name="responseErrors" value="#{#verifyConnectorsResponseJson.get('errors')}" />
        <log level="info" value="responseMessage: #{#responseMessage} , responseStatus: #{#responseStatus}" />
        <if condition="#{#verifyConnectorsResponseCode == 200}">
            <if condition="#{'success'.equals(#responseStatus)}">
                <var name="responseStatus" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#verifyConnectorsResponseJson, 'status')}" />
                <else>
                    <scriptError message="Failed to verify connectors" />
                    <log level="info" value="responseStatus: #{#responseStatus} is not success" />
                </else>
            </if>
            <else>
                <var name="errorMessage" value="#{#responseMessage != null ? #responseMessage : 'Verification failed'}" />
                <if condition="#{#responseErrors == null or #responseErrors.isJsonNull() or !#responseErrors.isJsonArray()}" >
                    <var name="responseErrorsItr" value="#{#responseErrors.getAsJsonArray().iterator()}" />
                    <var name="errorCauses" value="#{#}" />
                    <while condition="#{#responseErrorsItr.hasNext()}" >
                        <var name="responseError" value="#{#responseErrorsItr.next()}" />
                        <var name="errorField" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#responseError, 'field')}" />
                        <var name="errorMessage" value="#{T(com.unifier.core.utils.JsonUtils).getAsString(#responseError, 'message')}" />
                        <var name="errorCauses" value="#{#errorCauses + ' | '}" />
                    </while>

                </if>
                <scriptError message="#{#responseMessage}" />
            </else>
        </if>
    </method>

    <invoke method="prepareVerifyConnectorsHeaders" />
    <invoke method="prepareVerifyConnectorsBody" />
    <invoke method="doVerifyConnectorsRequest" />
    <invoke method="handleVerifyConnectorsResponse">
        <param name="verifyConnectorsResponseCode" value="#{#verifyConnectorsResponseResponseCode}" />
    </invoke>

</scraper>